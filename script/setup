#!/usr/bin/env python3
import argparse
import subprocess
import venv
from pathlib import Path

_DIR = Path(__file__).parent
_PROGRAM_DIR = _DIR.parent
_VENV_DIR = _PROGRAM_DIR / ".venv"

parser = argparse.ArgumentParser()
parser.add_argument(
    "--dev", action="store_true", help="Install dev requirements"
)
parser.add_argument(
    "--device",
    choices=["cpu", "cuda", "mps"],
    default="cpu",
    help="Target device for PyTorch installation (affects dependencies)",
)
args = parser.parse_args()

# Create virtual environment
builder = venv.EnvBuilder(with_pip=True)
context = builder.ensure_directories(_VENV_DIR)
builder.create(_VENV_DIR)

# Upgrade dependencies
pip = [context.env_exe, "-m", "pip"]
subprocess.check_call(pip + ["install", "--upgrade", "pip"])
subprocess.check_call(pip + ["install", "--upgrade", "setuptools", "wheel"])

# --- Determine Installation Extras ---
extras = []

# 1. Add Device Dependencies
if args.device in ["cuda", "mps"]:
    # Note: The 'cpu' case is the default installation of 'torch' 
    # handled by the main dependencies in pyproject.toml.
    extras.append(args.device)

# 2. Add Development Dependencies
if args.dev:
    extras.append("dev")

# Format the extras string: [cuda,dev] or [mps] etc.
extras_str = ""
if extras:
    extras_str = f"[{','.join(extras)}]"
# -----------------------------------

# Install requirements
subprocess.check_call(
    pip + ["install", "-e", f"{_PROGRAM_DIR}{extras_str}"]
)
